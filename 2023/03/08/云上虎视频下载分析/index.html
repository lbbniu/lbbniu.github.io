<!doctype html><html lang=zh dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>云上虎视频下载分析 | lbbniu</title>
<meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&amp;family=Noto+Serif+SC:wght@400;600;700&amp;display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/github.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/php.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/java.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/go.min.js crossorigin></script><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script><link rel=stylesheet href=/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=/js/fontawesome.min.35973bea57658ef0dd22ad59ea4642b6c8c67af62bed8659ac326d284ef285a6657cdbcf57d3b2910e7e992f2b20426e.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script><link rel=icon type=image/png sizes=32x32 href=/images/icon_hu46eef4dc61dcf438cf488ad55e1d2c12_638750_32x32_fill_box_center_3.png><link rel=apple-touch-icon sizes=180x180 href=/images/icon_hu46eef4dc61dcf438cf488ad55e1d2c12_638750_180x180_fill_box_center_3.png><meta name=description content="m3u8视频下载"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章列表","item":"/post/"},{"@type":"ListItem","position":2,"name":"云上虎视频下载分析","item":"/2023/03/08/%E4%BA%91%E4%B8%8A%E8%99%8E%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%88%86%E6%9E%90/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/2023/03/08/%E4%BA%91%E4%B8%8A%E8%99%8E%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%88%86%E6%9E%90/"},"headline":"云上虎视频下载分析 | lbbniu","datePublished":"2023-03-08T15:20:00+08:00","dateModified":"2023-03-08T15:20:00+08:00","wordCount":354,"author":{"@type":"Person","name":["lbbniu"]},"publisher":{"@type":"Person","name":"lbbniu","logo":{"@type":"ImageObject","url":"/images/icon.gif"}},"description":"m3u8视频下载"}</script><meta property="og:title" content="云上虎视频下载分析 | lbbniu"><meta property="og:type" content="article"><meta property="og:image" content="/images/icon.png"><meta property="og:url" content="/2023/03/08/%E4%BA%91%E4%B8%8A%E8%99%8E%E8%A7%86%E9%A2%91%E4%B8%8B%E8%BD%BD%E5%88%86%E6%9E%90/"><meta property="og:description" content="m3u8视频下载"><meta property="og:locale" content="zh"><meta property="og:site_name" content="lbbniu"><meta property="article:published_time" content="2023-03-08T15:20:00+08:00"><meta property="article:modified_time" content="2023-03-08T15:20:00+08:00"><meta property="article:section" content="post"><meta property="article:tag" content="m3u8"><meta property="article:tag" content="云上虎"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">lbbniu</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/post/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">文章</a>
<a href=/cloud-native/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">云原生</a>
<a href=/study/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">算法学习</a>
<a href=/docs/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Go学习训练营</a>
<a href=/tags/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">标签</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>浅色</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>深色</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>自动</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>云上虎视频下载分析</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2023-03-08</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>2分钟阅读时长</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=/categories/m3u8/ class=hover:text-eureka>m3u8</a></div></div><h2 id=声明>声明</h2><p><strong>本文章中所有内容仅供学习交流使用，不用于其他任何目的，不提供完整代码，抓包内容、敏感网址、数据接口等均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关！</strong></p><p><strong>本文章未经许可禁止转载，禁止任何修改后二次传播，擅自使用本文讲解的技术而导致的任何意外，作者均不负责，若有侵权，请在公众号【程序员大兵】联系作者立即删除！</strong></p><h2 id=逆向分析>逆向分析</h2><p>首先打开网课网站并登录账号，进入视频播放页面，然后打开开发者者工具看下<code>Fetch/XHR</code>类型网络请求。如下图所示：</p><p><img src=https://typora.lbbniu.com/typora/image-20230308092446865.png alt=image-20230308092446865></p><p>从上图<code>Fetch/XHR</code>类型网络请求中可以看到有请求<code>阿里云视频播放信息接口</code>的请求，可以展开对应请求看具体的请求信息，如下图所示：</p><p><img src=https://typora.lbbniu.com/typora/image-20230308092727632.png alt=image-20230308092727632></p><p><img src=https://typora.lbbniu.com/typora/image-20230308092812706.png alt=image-20230308092812706></p><p>观察网络请求，并没有发现有请求获取阿里云播放请求的<code>PlayAuth</code>的获取接口，从而可以推测出<code>PlayAuth</code>信息不是通过单独网站业务接口获取，可能是通过内嵌在网页的html中，下面通过右键点击网页选择显示网页源代码，如下图所示进行操作：</p><p><img src=https://typora.lbbniu.com/typora/image-20230308093236863.png alt=image-20230308093236863></p><p>打开网页源代码之后，搜索<code>PlayAuth</code>关键字进行定位关键信息，看是否能找到我们想要的的东西，如下图所示果然从网页源代码中找到了<code>PlayAuth</code>，找到<code>PlayAuth</code>之后响应下载对应视频就很简单了，只用使用我的 <a href=https://github.com/lbbniu/aliyun-m3u8-downloader target=_blank rel=noopener>https://github.com/lbbniu/aliyun-m3u8-downloader</a>
项目就可以轻松搞定了。从源代码中我们还可以看到有初始化<code>Aliplayer</code>的相关代码。</p><p><img src=https://typora.lbbniu.com/typora/image-20230308093939314.png alt=image-20230308093939314></p><p>下面演示下获取到<code>PlayAuth</code>之后如何使用 <a href=https://github.com/lbbniu/aliyun-m3u8-downloader target=_blank rel=noopener>https://github.com/lbbniu/aliyun-m3u8-downloader</a>
工具信息视频下载，如下图演示所示可以成功进行m3u8视频下载</p><p><img src=https://typora.lbbniu.com/typora/image-20230308094431553.png alt=image-20230308094431553></p><p>作为低级程序员，通过手动复制<code>PlayAuth</code>进行一个一个视频下载还是太麻烦和耗费视频了，如果可以通过程序输入对应视频课程地址自动获取课程下所有课程链接和<code>PlayAuth</code>就可以解放双手了。下面分析如何通过程序完成自动化的视频下载单个课程下的所有视频。</p><p>通过网站请求分析可以知道，网站是通过cookie中token进行用户身份鉴定和鉴权的。如下图：</p><p><img src=https://typora.lbbniu.com/typora/image-20230308095100149.png alt=image-20230308095100149></p><p>接下来首先使用<code>github.com/ddliu/go-httpclient</code>构造请求网站的httpclient，如下代码所示 ：</p><pre><code class=language-go>var huohujiaoyuClient *httpclient.HttpClient

huohujiaoyuClient = httpclient.NewHttpClient()
token := &quot;&lt;cookie 中 token&gt;&quot;
huohujiaoyuClient.Defaults(httpclient.Map{
    &quot;Accept&quot;:                 &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;,
    &quot;Connection&quot;:             &quot;keep-alive&quot;,
    &quot;Cookie&quot;:                 fmt.Sprintf(&quot;token=%s&quot;, token),
    httpclient.OPT_USERAGENT: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36&quot;,
})
</code></pre><p>对网站源码分析后，可以得知同html代码可以提取整个课程<code>知识讲解</code> 和<code>案例教材</code>的所有视频播放地址的链接地址。如下所示：</p><p><img src=https://typora.lbbniu.com/typora/image-20230308095924507.png alt=image-20230308095924507></p><p>提取html中视频播放链接地址我们可以使用 <code>github.com/PuerkitoBio/goquery</code>完成html数据提取，接下来我们使用httpclient 获取网页内容，并通过<code>goquery</code> 解析html分别获取<code>知识讲解</code> 和<code>案例教材</code>的对 <code>div</code>元素：</p><pre><code class=language-go>resp, err := huohujiaoyuClient.Get(url)
if err != nil {
    log.Fatalln(err)
}
doc, err := goquery.NewDocumentFromReader(resp.Body)
if err != nil {
    log.Fatalln(err)
}
title := doc.Find(&quot;.span-title&quot;).Text()
basePath := title
cachePath := &quot;cache&quot;
doc.Find(&quot;.course_playlist .list .scroll&quot;).Each(func(idx int, scroll *goquery.Selection) {
    var typ = &quot;知识讲解&quot;
    if idx != 0 {
        typ = &quot;案例教材&quot;
    }
    // 这里进一步获取a链接地址
})
</code></pre><p>获取<code>知识讲解</code> 和<code>案例教材</code>的对应<code>scroll</code>解析器之后，我们就可以利用 <code>scroll</code>解析器进一步提取<code>a</code>链接地址：</p><pre><code class=language-go>lessonPath := path.Join(basePath, typ)
scroll.Find(&quot;a&quot;).Each(func(idx2 int, a *goquery.Selection) {
	// 解析a链接地址，进行下一步分析
})
</code></pre><p>获取<code>a</code>链接解析之后，我们通过<code>a</code>链接解析器提取链接地址<code>href</code>属性，提取a标签的内容作为视频文件名，然后再通过httpclient获取页面内容提取<code>PlayAuth</code>内容，首先是提取<code>a</code>标签相关内容和获取页面内容：</p><pre><code class=language-go>href, ok := a.Attr(&quot;href&quot;)
if !ok {
    return
}
href = fmt.Sprintf(&quot;https://www.huohujiaoyu.com%s&quot;, href)
filename := fmt.Sprintf(&quot;%s.mp4&quot;, strings.TrimSpace(a.Text()))
filePath, exitsPath := path.Join(lessonPath, filename), path.Join(cachePath, lessonPath, filename+&quot;.download&quot;)
// 判断视频是否已经下载，如果存在没有错误
if _, err := os.Stat(exitsPath); err == nil {
    return
}
log.Println(idx, typ, idx2, href, a.Text())
// 获取视频播放页面内容
resp, err = huohujiaoyuClient.Get(href)
if err != nil {
    log.Fatalln(err)
}
detail, err := resp.ToString()
if err != nil {
    log.Fatalln(err)
}
</code></pre><p>接下来，解析页面内容提取<code>PlayAuth</code>信息，为了方便解析<code>PlayAuth</code>内容我们这里定义了一个结构体，我们可以利用 <a href=https://mholt.github.io/json-to-go/ target=_blank rel=noopener>https://mholt.github.io/json-to-go/</a>
快速通过json来生成go 结构体定义。</p><pre><code class=language-go>type PeriodDetail struct {
	ChannelID       interface{} `json:&quot;channelId&quot;`
	UserID          interface{} `json:&quot;userId&quot;`
	NickName        interface{} `json:&quot;nickName&quot;`
	Avatar          interface{} `json:&quot;avatar&quot;`
	ImToken         interface{} `json:&quot;imToken&quot;`
	MediaChannelKey interface{} `json:&quot;mediaChannelKey&quot;`
	VideoURL        string      `json:&quot;videoUrl&quot;`
	PlayAuth        string      `json:&quot;playAuth&quot;`
	CoverURL        string      `json:&quot;coverUrl&quot;`
	MaterialURL     string      `json:&quot;materialUrl&quot;`
	TaskURL         string      `json:&quot;taskUrl&quot;`
}

// 直接通过关键字进行提前包含 playAuth 的整个json字符串
index := strings.Index(detail, &quot;var periodDetail = &quot;)
if index &gt; len(detail) {
    log.Fatalln(&quot;内容中确实playAuth数据&quot;)
}
detail = detail[index+len(&quot;var periodDetail = &quot;):]
index = strings.Index(detail, &quot;};&quot;)
if index &gt; len(detail) {
    log.Fatalln(&quot;内容中确实playAuth数据&quot;)
}
detail = detail[:index+1]
var periodDetail PeriodDetail
if err = json.Unmarshal([]byte(detail), &amp;periodDetail); err != nil {
    log.Fatalln(err)
}
</code></pre><p>提取到<code>PlayAuth</code>就可以直接通过我的<code>github.com/lbbniu/aliyun-m3u8-downloader</code>工具进行视频下载了：</p><pre><code class=language-go>log.Println(&quot;start download&quot;, filePath)
if err := download.Aliyun(lessonPath, filename, chanSize, periodDetail.VideoURL, periodDetail.PlayAuth); err != nil {
    log.Fatalln(err)
}
// 标识已经下载, 防止重复下载
if err := writeFile(exitsPath, []byte(filePath), fs.ModePerm); err != nil {
    log.Fatalln(err)
}
log.Println(&quot;end download:&quot;, filePath)
</code></pre><p>writeFile 函数实现：</p><pre><code class=language-go>func writeFile(filename string, data []byte, perm fs.FileMode) error {
	if err := os.MkdirAll(filepath.Dir(filename), os.ModePerm); err != nil {
		log.Fatalln(err)
	}
	return ioutil.WriteFile(filename, data, perm)
}
</code></pre><p>到此整个网课平台视频下载分析全部完成。</p></article><div class=my-4><a href=/tags/m3u8/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#m3u8</a>
<a href=/tags/%E4%BA%91%E4%B8%8A%E8%99%8E/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#云上虎</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=/authors/lbbniu/ class="md:me-4 text-primary-text h-24 w-24"><i class="fas fa-user-circle fa-6x"></i></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=/authors/lbbniu/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>lbbniu</h3></a><span class="block pb-2"></span></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">上一页</span>
<a href=/2023/03/26/redis-cluster-vs-codis-slot-rebalance-%E7%AE%97%E6%B3%95/ class=block>Redis Cluster vs Codis Slot Rebalance 算法</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">下一页</span>
<a href=/2023/02/24/uri-addr/ class=block>Golang语法的25个练习题：21至25题</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>本页内容</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#声明>声明</a></li><li><a href=#逆向分析>逆向分析</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2021 <a href=https://blog.lbbniu.com/>lbbniu</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>